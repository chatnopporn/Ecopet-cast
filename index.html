<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>FSR → PVF Ratio</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="./mqttws31.min.js"></script>
<style>

    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;color:#1f2937}

    .wrap{max-width:960px;margin:24px auto;padding:0 16px}

    h1{font-size:22px;margin:8px 0}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 14px}

    .badge{padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:600;font-size:13px}

    .ok{color:#16a34a;background:#ecfdf5;border-color:#bbf7d0}

    .ng{color:#dc2626;background:#fff1f2;border-color:#fecaca}

    input,button{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}

    button{cursor:pointer;background:#fff}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}

    canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}

    .grid{display:grid;gap:12px}

    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .muted{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
<h1>FSR → PVF Ratio</h1>
<div class="row">
<span id="status" class="badge">Connecting…</span>
<span class="badge">Topic: <code id="topic">fsr/—</code></span>
<label>น้ำหนัก (กก.) <input id="kg" type="number" step="0.1" placeholder="เช่น 10" style="width:120px"></label>
</div>
<div class="grid">
<div class="card">
<h3>Realtime Ratio</h3>
<canvas id="realtime"></canvas>
<div class="muted" id="lastMsg">Last message: —</div>
</div>
<div class="card">
<h3>Daily Average Ratio (from Google Sheets)</h3>
<canvas id="daily"></canvas>
<div class="muted">* ดึงจาก Google Sheets CSV (ย้อนหลังอัตโนมัติ)</div>
</div>
</div>
</div>
<script>

/* ==== ตั้งค่า ==== */

const DEVICE_ID = "fsr-esp32-001";                    // ← ให้ตรงกับบอร์ด

const TOPIC     = "fsr/" + DEVICE_ID;

document.getElementById('topic').textContent = TOPIC;

const MQTT_HOST = "test.mosquitto.org";

const MQTT_PORT = 8081;

const MQTT_PATH = "/mqtt";

/* CSV ของชีต (ขั้นที่ 3) */

const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkmfEiPeuYhY4pAXiaJkBzSVimNH62tIAax5xykFss4B-7PSOEfnhq_NeFEnbNxEJg3floVNSu_gEA/pub?gid=0&single=true&output=csv"; // ← ใส่ของคุณ

/* ==== UI ==== */

const $status = document.getElementById('status');

const $kg     = document.getElementById('kg');

const $last   = document.getElementById('lastMsg');

const LS_KG = 'fsr_web_kg';

const savedKg = localStorage.getItem(LS_KG);

if (savedKg) $kg.value = savedKg;

$kg.addEventListener('change', ()=> localStorage.setItem(LS_KG, $kg.value));

/* ==== กราฟ ==== */

const rtChart = new Chart(document.getElementById('realtime'), {

  type:'line',

  data:{labels:[], datasets:[{label:'Ratio (F/PVF)', data:[], borderWidth:2, tension:.25}]},

  options:{scales:{x:{title:{display:true,text:'Time'}}, y:{beginAtZero:true, title:{display:true,text:'Ratio'}}}}

});

const dailyChart = new Chart(document.getElementById('daily'), {

  type:'line',

  data:{labels:[], datasets:[{label:'Daily Avg Ratio', data:[], borderWidth:2, tension:.2}]},

  options:{scales:{x:{title:{display:true,text:'Date'}}, y:{beginAtZero:true, title:{display:true,text:'Daily Avg'}}}}

});

/* ==== โหลดข้อมูลรายวันจากชีต (CSV) → เฉลี่ยต่อวัน ==== */

async function loadDailyFromSheet(){

  try{

    const res = await fetch(SHEET_CSV_URL, {cache:'no-store'});

    const text = await res.text();

    // ts, fsr, ratio

    const lines = text.trim().split(/\r?\n/);

    lines.shift(); // header

    const kg = parseFloat($kg.value);

    const byDay = {}; // {YYYY-MM-DD: {sum:0, n:0}}

    for (const line of lines) {

      const cols = line.split(","); // simple split

      if (cols.length < 3) continue;

      const tsStr = cols[0];

      const fsr = parseFloat(cols[1]);

      if (isNaN(fsr)) continue;

      // คำนวณ ratio ด้วยน้ำหนักที่กรอก (เพื่อให้ daily สอดคล้องกับ realtime)

      if (!kg || kg <= 0) continue;

      const F   = 100 * (1 - fsr/4095);

      const PVF = 0.2 * (kg * 9.81);

      const ratio = PVF > 0 ? F / PVF : 0;

      const d = new Date(tsStr);

      const key = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');

      if (!byDay[key]) byDay[key] = {sum:0, n:0};

      byDay[key].sum += ratio; byDay[key].n++;

    }

    const labels = Object.keys(byDay).sort();

    const data   = labels.map(k => byDay[k].sum / byDay[k].n);

    dailyChart.data.labels = labels;

    dailyChart.data.datasets[0].data = data;

    dailyChart.update();

  }catch(e){

    console.error("loadDailyFromSheet error:", e);

  }

}

loadDailyFromSheet();

$kg.addEventListener('change', loadDailyFromSheet);

// รีเฟรชทุก 5 นาที

setInterval(loadDailyFromSheet, 5*60*1000);

/* ==== MQTT (WSS) Realtime ==== */

function setStatus(ok,msg){ $status.className='badge ' + (ok?'ok':'ng'); $status.textContent=msg; }

function connectMQTT(){

  if (typeof window.Paho === 'undefined') {

    setStatus(false, 'Paho not loaded');

    return;

  }

  const clientId = "web-" + Math.random().toString(16).slice(2);

  const client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, MQTT_PATH, clientId);

  client.onConnectionLost = () => { setStatus(false,'Disconnected'); setTimeout(connectMQTT,3000); };

  client.onMessageArrived = (msg)=>{

    $last.textContent = "Last message: " + msg.payloadString;

    try{

      let fsr; const t = msg.payloadString.trim();

      if (t.startsWith("{")) fsr = Number(JSON.parse(t).fsr); else fsr = Number(t);

      const kg = parseFloat($kg.value); if (!kg || kg<=0 || Number.isNaN(fsr)) return;

      const F   = 100 * (1 - fsr/4095);

      const PVF = 0.2 * (kg * 9.81);

      const ratio = PVF>0 ? F/PVF : 0;

      const now = new Date().toLocaleTimeString();

      const ds = rtChart.data.datasets[0].data, ls = rtChart.data.labels;

      if (ls.length>60){ ls.shift(); ds.shift(); }

      ls.push(now); ds.push(ratio); rtChart.update();

    }catch(e){ console.warn("Bad payload:", msg.payloadString, e); }

  };

  setStatus(false,'Connecting…');

  client.connect({

    useSSL:true, timeout:10, keepAliveInterval:30,

    onSuccess: ()=>{ setStatus(true,'Connected'); client.subscribe(TOPIC); },

    onFailure: ()=>{ setStatus(false,'Connect failed'); setTimeout(connectMQTT,3000); }

  });

}

connectMQTT();
</script>
</body>
</html>
 