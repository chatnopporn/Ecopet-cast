<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>FSR ‚Üí PVF Ratio (Basic)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Paho MQTT (‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡∏Ñ‡∏±‡∏•) -->
<script src="./mqttws31.min.js"></script>
<style>
   body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;color:#1f2937}
   .wrap{max-width:960px;margin:24px auto;padding:0 16px}
   h1{font-size:22px;margin:8px 0}
   .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 14px}
   .badge{padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:600;font-size:13px}
   .ok{color:#16a34a;background:#ecfdf5;border-color:#bbf7d0}
   .ng{color:#dc2626;background:#fff1f2;border-color:#fecaca}
   input,button{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
   button{cursor:pointer;background:#fff}
   .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
   .alert{display:none;margin-top:8px;padding:10px;border:1px solid #fecaca;background:#fff1f2;color:#991b1b;border-radius:10px;font-weight:600}
   canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
   .grid{display:grid;gap:12px}
   @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
   .muted{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
<h1>FSR ‚Üí PVF Ratio (Basic, No Backend)</h1>
<div class="row">
<span id="status" class="badge">Connecting‚Ä¶</span>
<span class="badge">Topic: <code id="topic">fsr/‚Äî</code></span>
<label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.) <input id="kg" type="number" step="0.1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" style="width:120px"></label>
<button id="btnNotify">üîî Enable alerts</button>
<button id="btnClear">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)</button>
</div>
<div class="card">
<div class="muted" id="lastMsg">Last message: ‚Äî</div>
<div id="warn" class="alert">‚ö†Ô∏è Ratio > 1 ‚Äî ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏ö</div>
</div>
<div class="grid">
<div class="card">
<h3>Realtime Ratio</h3>
<canvas id="realtime"></canvas>
</div>
<div class="card">
<h3>Daily Average Ratio (LocalStorage)</h3>
<canvas id="daily"></canvas>
<div class="muted">* ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div>
</div>
</div>
</div>
<script>
/* ===== 1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏£‡πå‡∏î ===== */
const DEVICE_ID = "fsr-esp32-001";                 // ‚Üê ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const TOPIC     = "fsr/" + DEVICE_ID;              // = fsr/fsr-esp32-001
document.getElementById('topic').textContent = TOPIC;
// Broker WSS (Mosquitto public)
const MQTT_HOST = "test.mosquitto.org";
const MQTT_PORT = 8081;
const MQTT_PATH = "/mqtt";
/* ===== 2) UI/‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ===== */
const $status  = document.getElementById('status');
const $kg      = document.getElementById('kg');
const $btnN    = document.getElementById('btnNotify');
const $btnClr  = document.getElementById('btnClear');
const $warn    = document.getElementById('warn');
const $lastMsg = document.getElementById('lastMsg');
const LS_KG      = 'fsr_basic_kg';
const LS_DAILY   = 'fsr_basic_daily';
const LS_ENABLED = 'fsr_basic_notify';
const savedKg = localStorage.getItem(LS_KG);
if (savedKg) $kg.value = savedKg;
$kg.addEventListener('change', ()=> localStorage.setItem(LS_KG, $kg.value));
/* ===== 3) ‡∏Å‡∏£‡∏≤‡∏ü ===== */
const rtChart = new Chart(document.getElementById('realtime'), {
 type:'line',
 data:{labels:[], datasets:[{label:'Ratio (F/PVF)', data:[], borderWidth:2, tension:.25}]},
 options:{scales:{x:{title:{display:true,text:'Time'}}, y:{beginAtZero:true, title:{display:true, text:'Ratio'}}}}
});
const dailyChart = new Chart(document.getElementById('daily'), {
 type:'line',
 data:{labels:[], datasets:[{label:'Daily Avg Ratio', data:[], borderWidth:2, tension:.2}]},
 options:{scales:{x:{title:{display:true,text:'Date'}}, y:{beginAtZero:true, title:{display:true, text:'Daily Avg'}}}}
});
/* ===== 4) ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Browser Notification + ‡πÄ‡∏™‡∏µ‡∏¢‡∏á) ===== */
let lastNotify = 0;
const COOLDOWN = 15000;
if (localStorage.getItem(LS_ENABLED) === '1') {
 // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
 if (Notification.permission === 'granted') {
   $btnN.textContent = 'üîî Alerts enabled'; $btnN.disabled = true;
 }
}
$btnN.addEventListener('click', async ()=>{
 const perm = await Notification.requestPermission();
 if (perm === 'granted') {
   localStorage.setItem(LS_ENABLED, '1');
   $btnN.textContent = 'üîî Alerts enabled';
   $btnN.disabled = true;
   notify(1.01, true);
 } else {
   alert('‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Notifications ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ');
 }
});
function notify(ratio, isTest=false){
 const now = Date.now();
 if (!isTest && now - lastNotify < COOLDOWN) return;
 lastNotify = now;
 if ('Notification' in window && Notification.permission === 'granted') {
   new Notification(isTest ? 'Alerts enabled' : '‚ö†Ô∏è High Load Detected',
                    { body: isTest ? '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : `Ratio = ${ratio.toFixed(2)} > 1` });
 }
 try{
   const ctx = new (window.AudioContext||window.webkitAudioContext)();
   const o = ctx.createOscillator(); const g = ctx.createGain();
   o.frequency.value = 880; g.gain.value = 0.05;
   o.connect(g); g.connect(ctx.destination); o.start();
   setTimeout(()=>{ o.stop(); ctx.close(); }, 300);
 }catch(_){}
 if (navigator.vibrate) navigator.vibrate([120,80,120]);
}
/* ===== 5) ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö LocalStorage ===== */
function dateKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
let dailyAgg = JSON.parse(localStorage.getItem(LS_DAILY) || '{}'); // { 'YYYY-MM-DD': {sum, n} }
function addDaily(ratio){
 const k = dateKey(new Date());
 if (!dailyAgg[k]) dailyAgg[k] = {sum:0, n:0};
 dailyAgg[k].sum += ratio; dailyAgg[k].n += 1;
 localStorage.setItem(LS_DAILY, JSON.stringify(dailyAgg));
 renderDaily();
}
function renderDaily(){
 const keys = Object.keys(dailyAgg).sort();
 dailyChart.data.labels = keys;
 dailyChart.data.datasets[0].data = keys.map(k => dailyAgg[k].sum / dailyAgg[k].n);
 dailyChart.update();
}
renderDaily();
$btnClr.addEventListener('click', ()=>{
 if (!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ)?')) return;
 dailyAgg = {};
 localStorage.setItem(LS_DAILY, JSON.stringify(dailyAgg));
 renderDaily();
});
/* ===== 6) MQTT (WSS) ‚Äî ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ===== */
function setStatus(ok, msg){
 $status.className = 'badge ' + (ok ? 'ok':'ng');
 $status.textContent = msg;
}
function connectMQTT(){
 if (typeof window.Paho === 'undefined') {
   setStatus(false, 'Paho not loaded (‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ü‡∏•‡πå mqttws31.min.js)');
   return;
 }
 const clientId = "web-" + Math.random().toString(16).slice(2);
 const client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, MQTT_PATH, clientId);
 client.onConnectionLost = () => { setStatus(false, 'Disconnected (retry in 3s)'); setTimeout(connectMQTT, 3000); };
 client.onMessageArrived = (msg)=>{
   $lastMsg.textContent = "Last message: " + msg.payloadString;
   try{
     // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á JSON {"fsr":...} ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô
     let fsr;
     const t = msg.payloadString.trim();
     if (t.startsWith("{")) fsr = Number(JSON.parse(t).fsr);
     else fsr = Number(t);
     const kg = parseFloat($kg.value);
     if (!kg || kg <= 0 || Number.isNaN(fsr)) return;
     const F   = 100 * (1 - fsr/4095);
     const PVF = 0.2 * (kg * 9.81);
     const ratio = F / PVF;
     // ‡∏Å‡∏£‡∏≤‡∏ü realtime (‡∏à‡∏≥‡∏Å‡∏±‡∏î ~60 ‡∏à‡∏∏‡∏î)
     const now = new Date().toLocaleTimeString();
     const ds = rtChart.data.datasets[0].data;
     const ls = rtChart.data.labels;
     if (ls.length > 60){ ls.shift(); ds.shift(); }
     ls.push(now); ds.push(ratio); rtChart.update();
     // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
     if (ratio > 1){ $warn.style.display = 'block'; notify(ratio); }
     else { $warn.style.display = 'none'; }
     // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (local)
     addDaily(ratio);
   }catch(e){ console.warn("Bad payload:", msg.payloadString, e); }
 };
 setStatus(false, 'Connecting‚Ä¶');
 client.connect({
   useSSL:true, timeout:10, keepAliveInterval:30,
   onSuccess: ()=>{ setStatus(true, 'Connected'); client.subscribe(TOPIC); },
   onFailure: ()=>{ setStatus(false, 'Connect failed (retry in 3s)'); setTimeout(connectMQTT, 3000); }
 });
}
connectMQTT();
</script>
</body>
</html>